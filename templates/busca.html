{% extends "base.html" %}
{% block title %}Busca | Fichas de Malharia{% endblock %}
{% block content %}

<div class="page-head">
  <div>
    <h1>Busca de Fichas</h1>
    <p class="sub">Use os filtros para encontrar a ficha certa e adicione ao carrinho.</p>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <form class="grid" method="get">
    <label>
      Tipo de malha
      <select name="tipo">
        <option value="">Todos</option>
        {% for t in tipos %}
          <option value="{{ t }}" {% if filtros.tipo == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Categoria
      <select name="categoria">
        <option value="">Todas</option>
        {% for c in categorias %}
          <option value="{{ c }}" {% if filtros.categoria == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Composição (contém)
      <input name="composicao" value="{{ filtros.composicao or '' }}" placeholder="Ex: elastano">
    </label>

    <label>
      Gramatura mín.
      <input type="number" name="gramatura_min" value="{{ filtros.gramatura_min or '' }}">
    </label>

    <label>
      Gramatura máx.
      <input type="number" name="gramatura_max" value="{{ filtros.gramatura_max or '' }}">
    </label>

    <button class="btn" type="submit">Filtrar</button>
    <a class="btn ghost" href="/busca">Limpar</a>
  </form>
</div>

<div class="results">
  {% if fichas|length == 0 %}
    <p style="margin-top:12px;">Nenhuma ficha encontrada com esses filtros.</p>
  {% else %}
    {% for f in fichas %}
      <div class="card ficha">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
          <div>
            <h3>{{ f.titulo }}</h3>
            <div class="meta">
              <span><b>Tipo:</b> {{ f.tipo_malha }}</span>
              <span><b>Comp:</b> {{ f.composicao }}</span>
              <span><b>Gram:</b> {{ f.gramatura }} g/m²</span>
              <span><b>Larg:</b> {{ "%.2f"|format(f.largura) }} m</span>
              <span><b>Categoria:</b> {{ f.categoria }}</span>
            </div>
          </div>

          <a class="link" href="/ficha/{{ f.id }}">Ver detalhes</a>
        </div>

        <div class="actions">
          <div class="price">R$ {{ "%.2f"|format(f.preco) }}</div>

          <div class="actions-right">
            {% set no_carrinho = (cart_ids is defined and f.id in cart_ids) %}

            {% if no_carrinho %}
              <span class="btn ghost" style="pointer-events:none; opacity:.9;">✅ No carrinho</span>

              <form method="post" action="/cart/remove/{{ f.id }}" style="margin:0;">
                <button class="btn ghost" type="submit">Remover</button>
              </form>
            {% else %}
              <form method="post" action="/cart/add/{{ f.id }}" style="margin:0;">
                <button class="btn" type="submit">Adicionar ao carrinho</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

{% endblock %}
