{% extends "base.html" %}
{% block title %}Busca | Fichas de Malharia{% endblock %}
{% block content %}

<div class="page-head">
  <div class="page-head-left">
    <h1 class="page-title">Busca de Fichas</h1>

    {% if results_count is defined %}
      <div class="muted page-subtitle">
        {{ results_count }} resultado{% if results_count != 1 %}s{% endif %} encontrado{% if results_count != 1 %}s{% endif %}
      </div>
    {% endif %}
  </div>

  <a class="btn ghost head-cart" href="/cart">
    üõí Carrinho
    {% if cart_count and cart_count > 0 %}
      <span class="badge badge--solid" aria-label="Itens no carrinho" title="Itens no carrinho">
        {{ cart_count }}
      </span>
    {% endif %}
  </a>
</div>

<div class="card" style="margin-top:14px;">
  <form class="grid" method="get">
    <label>
      Tipo de malha
      <select name="tipo">
        <option value="">Todos</option>
        {% for t in tipos %}
          <option value="{{ t }}" {% if filtros.tipo == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Categoria
      <select name="categoria">
        <option value="">Todas</option>
        {% for c in categorias %}
          <option value="{{ c }}" {% if filtros.categoria == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Composi√ß√£o (cont√©m)
      <input name="composicao" value="{{ filtros.composicao or '' }}" placeholder="Ex: elastano">
    </label>

    <label>
      Gramatura m√≠n.
      <input type="number" name="gramatura_min" value="{{ filtros.gramatura_min or '' }}">
    </label>

    <label>
      Gramatura m√°x.
      <input type="number" name="gramatura_max" value="{{ filtros.gramatura_max or '' }}">
    </label>

    <button class="btn" type="submit">Filtrar</button>
    <a class="btn ghost" href="/busca">Limpar</a>
  </form>
</div>

<div class="results">
  {% if fichas|length == 0 %}
    <p>Nenhuma ficha encontrada com esses filtros.</p>
  {% else %}
    {% for f in fichas %}
      <div class="card ficha">

        <div class="row-between">
          <h3 style="margin:0;">{{ f.titulo }}</h3>
          <a class="link" href="/ficha/{{ f.id }}">Ver detalhes</a>
        </div>

        <div class="meta" style="margin-top:10px;">
          <span><b>Tipo:</b> {{ f.tipo_malha }}</span>
          <span><b>Comp:</b> {{ f.composicao }}</span>
          <span><b>Gram:</b> {{ f.gramatura }} g/m¬≤</span>
          <span><b>Larg:</b> {{ "%.2f"|format(f.largura) }} m</span>
          <span><b>Categoria:</b> {{ f.categoria }}</span>
        </div>

        <div class="actions" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px;">
          <div class="price">R$ {{ "%.2f"|format(f.preco) }}</div>

          <div style="display:flex; gap:10px; align-items:center;">
            {% set no_carrinho = (cart_ids is defined and f.id in cart_ids) %}

            {% if no_carrinho %}
              <span class="btn ghost" style="pointer-events:none; opacity:.85;">‚úÖ No carrinho</span>

              <form method="post" action="/cart/remove/{{ f.id }}" style="margin:0;">
                <button class="btn ghost" type="submit">Remover</button>
              </form>
            {% else %}
              <form method="post" action="/cart/add/{{ f.id }}" style="margin:0;">
                <button class="btn" type="submit">Adicionar ao carrinho</button>
              </form>
            {% endif %}
          </div>
        </div>

      </div>
    {% endfor %}
  {% endif %}
</div>

{% endblock %}
